<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{password.reset.form.title}">Reset Password</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
            padding: 30px;
        }

        .header {
            background-color: #4F46E5;
            color: #ffffff;
            padding: 20px;
            text-align: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            margin: -30px -30px 20px -30px;
        }

        h1 {
            color: inherit;
            margin: 0;
            font-size: 1.75em;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            text-align: left;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        input[type="password"] {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            padding: 12px 25px;
            background-color: #4F46E5;
            color: #ffffff !important;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #4338CA;
        }

        button:disabled {
            background-color: #A0A0A0;
            cursor: not-allowed;
        }

        .error-message {
            color: #dc3545;
            margin-top: 10px;
            display: none;
            font-weight: bold;
        }

        .success-message {
            color: #28a745;
            margin-top: 10px;
            display: none;
            font-weight: bold;
        }

        .password-requirements {
            text-align: left;
            margin-top: 10px;
            color: #777;
            font-size: 0.9em;
        }

        .password-requirements p {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .password-requirements i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .password-requirements .met {
            color: green;
        }

        .password-requirements .met i.fa-check-circle {
            color: green;
        }

        .password-requirements .not-met i.fa-times-circle {
            color: #dc3545;
        }

        .match-indicator {
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
            font-weight: bold;
            align-items: center;
        }

        .match-indicator i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .match {
            color: green;
        }

        .no-match {
            color: red;
        }

        .strength-meter {
            background-color: #ddd;
            height: 5px;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .strength-fill {
            height: 5px;
            border-radius: 3px;
            width: 0;
            transition: width 0.3s ease;
        }

        .strength-weak-color {
            background-color: red;
        }

        .strength-fair-color {
            background-color: orange;
        }

        .strength-good-color {
            background-color: yellowgreen;
        }

        .strength-strong-color {
            background-color: green;
        }

        .strength-label {
            text-align: left;
            font-size: 0.8em;
            margin-top: 3px;
            color: #777;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1 th:text="#{password.reset.form.heading}">Reset Your Password</h1>
    </div>
    <form id="passwordResetForm">
        <input type="hidden" name="token" th:value="${token}"/>
        <label for="newPassword" th:text="#{password.reset.form.new_password}">New Password:</label>
        <input type="password" id="newPassword" name="newPassword" required minlength="8" maxlength="15">
        <div class="password-requirements">
            <p id="req-length"><i class="fas fa-times-circle"></i> <span
                    th:text="#{password.reset.form.requirements.length}">8-15 characters</span></p>
            <p id="req-upper"><i class="fas fa-times-circle"></i> <span
                    th:text="#{password.reset.form.requirements.upper}">At least one uppercase letter</span></p>
            <p id="req-lower"><i class="fas fa-times-circle"></i> <span
                    th:text="#{password.reset.form.requirements.lower}">At least one lowercase letter</span></p>
            <p id="req-number"><i class="fas fa-times-circle"></i> <span
                    th:text="#{password.reset.form.requirements.number}">At least one number</span></p>
            <p id="req-special"><i class="fas fa-times-circle"></i> <span
                    th:text="#{password.reset.form.requirements.special}">At least one special character (@#$%^&+=!*()-_)</span>
            </p>
        </div>
        <div class="strength-meter">
            <div id="strengthFill" class="strength-fill"></div>
        </div>
        <div class="strength-label">
            <span id="strength-weak-text" style="display:none;"
                  th:text="#{password.reset.form.strength.weak}">Weak</span>
            <span id="strength-fair-text" style="display:none;"
                  th:text="#{password.reset.form.strength.fair}">Fair</span>
            <span id="strength-good-text" style="display:none;"
                  th:text="#{password.reset.form.strength.good}">Good</span>
            <span id="strength-strong-text" style="display:none;" th:text="#{password.reset.form.strength.strong}">Strong</span>
        </div>

        <label for="confirmPassword" th:text="#{password.reset.form.confirm_password}">Confirm New Password:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8" maxlength="15">
        <div id="matchIndicator" class="match-indicator">
            <span id="match-icon"></span>&nbsp;
            <span id="match-text-match" style="display:none;" th:text="#{password.reset.form.match_indicator.match}">Passwords match</span>
            <span id="match-text-no-match" style="display:none;"
                  th:text="#{password.reset.form.match_indicator.no_match}">Passwords do not match</span>
        </div>

        <button type="submit" id="submitBtn" th:text="#{password.reset.form.submit}" disabled>Reset Password</button>
        <div id="passwordMismatchError" class="error-message" th:text="#{password.reset.form.mismatch_error}">Passwords
            do not match.
        </div>
        <div id="successMessage" class="success-message"></div>
        <div id="serverError" class="error-message"></div>

        <div style="display:none;">
            <span id="resetting-button-text" th:text="#{password.reset.form.resetting_button_text}">Resetting...</span>
            <span id="server-error-fallback-text" th:text="#{password.reset_password.server_error}">An unexpected error occurred. Please try again.</span>
        </div>
    </form>
    <script>
        class PasswordValidator {
            constructor() {
                this.newPasswordInput = document.getElementById('newPassword');
                this.confirmPasswordInput = document.getElementById('confirmPassword');
                this.submitBtn = document.getElementById('submitBtn');
                this.errorDiv = document.getElementById('passwordMismatchError');
                this.successDiv = document.getElementById('successMessage');
                this.serverErrorDiv = document.getElementById('serverError');
                this.matchIndicator = document.getElementById('matchIndicator');
                this.matchIconElement = document.getElementById('match-icon');
                this.matchTextMatchElement = document.getElementById('match-text-match');
                this.matchTextNoMatchElement = document.getElementById('match-text-no-match');
                this.strengthFill = document.getElementById('strengthFill');
                this.strengthWeakText = document.getElementById('strength-weak-text');
                this.strengthFairText = document.getElementById('strength-fair-text');
                this.strengthGoodText = document.getElementById('strength-good-text');
                this.strengthStrongText = document.getElementById('strength-strong-text');
                this.passwordResetForm = document.getElementById('passwordResetForm');
                this.tokenInput = document.querySelector('input[name="token"]');

                this.originalSubmitBtnText = this.submitBtn.textContent;
                this.resettingBtnText = document.getElementById('resetting-button-text').textContent;
                this.serverErrorFallbackText = document.getElementById('server-error-fallback-text').textContent;


                this.requirements = {
                    length: {
                        element: document.getElementById('req-length'),
                        icon: document.getElementById('req-length').querySelector('i'),
                        test: (pwd) => pwd.length >= 8 && pwd.length <= 15
                    },
                    upper: {
                        element: document.getElementById('req-upper'),
                        icon: document.getElementById('req-upper').querySelector('i'),
                        test: (pwd) => /[A-Z]/.test(pwd)
                    },
                    lower: {
                        element: document.getElementById('req-lower'),
                        icon: document.getElementById('req-lower').querySelector('i'),
                        test: (pwd) => /[a-z]/.test(pwd)
                    },
                    number: {
                        element: document.getElementById('req-number'),
                        icon: document.getElementById('req-number').querySelector('i'),
                        test: (pwd) => /[0-9]/.test(pwd)
                    },
                    special: {
                        element: document.getElementById('req-special'),
                        icon: document.getElementById('req-special').querySelector('i'),
                        test: (pwd) => /[@#$%^&+=!*()\-_]/.test(pwd)
                    }
                };

                this.init();
            }

            init() {
                this.newPasswordInput.addEventListener('input', () => this.validatePassword());
                this.confirmPasswordInput.addEventListener('input', () => this.validatePasswordMatch());
                this.passwordResetForm.addEventListener('submit', (e) => this.handleSubmit(e));
                this.validatePassword();
                this.validatePasswordMatch();
                this.updateSubmitButton();
            }

            validatePassword() {
                const password = this.newPasswordInput.value;
                let metRequirements = 0;

                Object.keys(this.requirements).forEach(key => {
                    const req = this.requirements[key];
                    const isMet = req.test(password);

                    req.element.classList.toggle('met', isMet);
                    req.element.classList.toggle('not-met', !isMet);

                    if (isMet) {
                        req.icon.classList.remove('fa-times-circle');
                        req.icon.classList.add('fa-check-circle');
                    } else {
                        req.icon.classList.remove('fa-check-circle');
                        req.icon.classList.add('fa-times-circle');
                    }

                    if (isMet) metRequirements++;
                });
                this.updateStrengthMeter(metRequirements, password);
                this.updateSubmitButton();
            }

            updateStrengthMeter(metRequirements, password) {
                const strengthFill = this.strengthFill;
                const weakText = this.strengthWeakText;
                const fairText = this.strengthFairText;
                const goodText = this.strengthGoodText;
                const strongText = this.strengthStrongText;

                strengthFill.className = 'strength-fill';
                weakText.style.display = 'none';
                fairText.style.display = 'none';
                goodText.style.display = 'none';
                strongText.style.display = 'none';
                strengthFill.style.width = password ? `${(metRequirements / 5) * 100}%` : '0%';

                if (password) {
                    if (metRequirements >= 0 && metRequirements < 2) {
                        strengthFill.classList.add('strength-weak-color');
                        weakText.style.display = 'inline';
                    } else if (metRequirements >= 2 && metRequirements < 3) {
                        strengthFill.classList.add('strength-fair-color');
                        fairText.style.display = 'inline';
                    } else if (metRequirements >= 3 && metRequirements < 5) {
                        strengthFill.classList.add('strength-good-color');
                        goodText.style.display = 'inline';
                    } else if (metRequirements === 5) {
                        strengthFill.classList.add('strength-strong-color');
                        strongText.style.display = 'inline';
                    }
                }
            }

            validatePasswordMatch() {
                const password = this.newPasswordInput.value;
                const confirmPassword = this.confirmPasswordInput.value;
                const passwordsMatch = password === confirmPassword;
                const matchIcon = this.matchIconElement;
                const matchTextMatchElement = this.matchTextMatchElement;
                const matchTextNoMatchElement = this.matchTextNoMatchElement;

                this.matchIndicator.style.display = confirmPassword ? 'flex' : 'none';
                matchTextMatchElement.style.display = passwordsMatch ? 'inline' : 'none';
                matchTextNoMatchElement.style.display = passwordsMatch ? 'none' : 'inline';

                if (passwordsMatch) {
                    matchIcon.className = 'fas fa-check-circle match';
                    this.matchIndicator.classList.remove('no-match');
                    this.matchIndicator.classList.add('match');
                    this.errorDiv.style.display = 'none';
                } else {
                    matchIcon.className = 'fas fa-times-circle no-match';
                    this.matchIndicator.classList.remove('match');
                    this.matchIndicator.classList.add('no-match');
                    this.errorDiv.style.display = 'block';
                }

                this.updateSubmitButton();
            }

            updateSubmitButton() {
                const isPasswordValid = this.isPasswordValid();
                const isMatchValid = this.isPasswordMatchValid();
                this.submitBtn.disabled = !(isPasswordValid && isMatchValid);
            }

            isPasswordValid() {
                const password = this.newPasswordInput.value;
                return Object.values(this.requirements).every(req => req.test(password));
            }

            isPasswordMatchValid() {
                const password = this.newPasswordInput.value;
                const confirmPassword = this.confirmPasswordInput.value;
                return password !== '' && confirmPassword !== '' && password === confirmPassword;
            }

            async handleSubmit(event) {
                event.preventDefault();

                this.errorDiv.style.display = 'none';
                this.successDiv.style.display = 'none';
                this.serverErrorDiv.style.display = 'none';

                if (!this.isPasswordValid() || !this.isPasswordMatchValid()) {
                    this.errorDiv.style.display = 'block';
                    return;
                }

                this.passwordResetForm.classList.add('loading');
                this.submitBtn.textContent = this.resettingBtnText;
                this.submitBtn.disabled = true;

                try {
                    const response = await fetch('/v1/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: this.tokenInput.value,
                            newPassword: this.newPasswordInput.value,
                            confirmPassword: this.confirmPasswordInput.value
                        })
                    });

                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        if (response.ok) {
                            this.successDiv.textContent = result.message;
                            this.successDiv.style.display = 'block';
                            setTimeout(() => {
                                window.location.href = '/v1/auth/reset-password/success';
                            }, 1000);
                        } else {
                            this.serverErrorDiv.textContent = result.message || this.serverErrorFallbackText;
                            this.serverErrorDiv.style.display = 'block';
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Server responded with non-JSON content:', errorText);
                        this.serverErrorDiv.textContent = this.serverErrorFallbackText;
                        this.serverErrorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.serverErrorDiv.textContent = this.serverErrorFallbackText;
                    this.serverErrorDiv.style.display = 'block';
                } finally {
                    this.passwordResetForm.classList.remove('loading');
                    this.submitBtn.textContent = this.originalSubmitBtnText;
                    this.updateSubmitButton();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.validator = new PasswordValidator();
        });
    </script>
</div>
</body>
</html>
